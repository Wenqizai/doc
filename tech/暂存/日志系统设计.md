1. 技术选型
before: elk + kinaba, 内存贵
after: lk + doris 


OLAP 实时统计数据库


[Spring Cloud 系列之 Sleuth 链路追踪（一） - 哈喽沃德先生 - 博客园](https://www.cnblogs.com/mrhelloworld/p/sleuth1.html)

[Spring Cloud Sleuth 2.0概要使用说明 - BTStream's Blog](https://blog.btstream.net/post/2019-01-14-spring-cloud-sleuth-2.0%E6%A6%82%E8%A6%81%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/)

基于 clickhouse 的日志系统

[JLog: 来自京东App秒级百G级日志搜集、传输、存储解决方案](https://gitee.com/jd-platform-opensource/jlog?_from=gitee_search)


> 思想

[51 分布式下如何实现统一日志系统？](https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%9845%E8%AE%B2-%E5%AE%8C/51%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8B%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%EF%BC%9F.md)

[性能调优之日志打印的坑 - 楼兰胡杨 - 博客园](https://www.cnblogs.com/east7/p/18013052)

> 工具

正则表达式练习：[ttps://regexlearn.com/](https://regexlearn.com/)


# logback
## 相关文档

官方文档：[Documentation](https://logback.qos.ch/documentation.html)
中文文档：  [README | logback](https://logbackcn.gitbook.io/logback)



> 一些坑 

1. 应用服务内压缩日志导致 cpu 过高问题: 不应该在应用服务内执行压缩, 应该将日志文件转移至其他空闲服务器执行压缩.

[技术干货|关于logback日志压缩的那点事 - 知乎](https://zhuanlan.zhihu.com/p/133425425)

## 架构

日志级别：**TRACE** < **DEBUG** < **INFO** < **WARN** < **ERROR**。

⚠️upload failed, check dev console
![[Logback 日志级别.png]]

## 流程

1. 定义 `logback.xml`，维护 root logger，自定义 Appender，filter，level；
2. 获取 logger，`Logger logger = LoggerFactory.getLogger("className or loggerName");`，如果没有找到自定义的 logger，一直往父级查找，直到 root logger，查找到第一个 logger 为止。
3. 使用获取到的 logger，判断日志的优先级时候执行，获取 logger 绑定的 Appender，执行 `doAppend()` 方法，打印日志。


参考文档：[打印日志时 Logback 内部都做了些什么](https://tech.youzan.com/how-logback-print-log/)
## 注意点
1. 定义多个 root 节点

`logback.xml` 中定义多个 root 节点时，后面的 root 节点定义会覆盖前面的定义。具体还需要看解析器的执行。而且这种做法是不规范，会导致 appender 绑定混乱。标准做法是只定义一个 root 节点。


2. 配置 additivity = false

- 子 logger 会默认继承父 logger 的 appender，将它们加入到自己的 Appender 中；除非加上了**additivity="false"**，则不再继承父 logger 的 appender。
- 子 logger 只在自己未定义输出级别的情况下，才会继承父 logger 的输出级别。
- 【**强制】** 避免重复打印日志，浪费磁盘空间，务必在日志配置文件中设置 additivity=false


# Log4j2

官方文档：[Log4j – Overview](https://logging.apache.org/log4j/2.x/manual/index.html)
中文文档：[Log4j2 中文文档 - 欢迎使用 Log4j 2！ | Docs4dev](https://www.docs4dev.com/docs/zh/log4j2/2.x/all/manual-index.html)
github: [GitHub - apache/logging-log4j2: Apache Log4j 2 is a versatile, feature-rich, efficient logging API and backend for Java.](https://github.com/apache/logging-log4j2)

## 博客

1. 日志的执行流程，异步的无锁数据结构 Disruptor
[Log4j2中的同步日志与异步日志 - Ye\_yang - 博客园](https://www.cnblogs.com/yeyang/p/7944906.html)

![[Log4j2日志输出方式同步和异步.png]]



## API

> 获取 logger
-  `org.apache.logging.log4j.spi.AbstractLoggerAdapter#getLogger`

>构建 log 消息
- `org.apache.logging.log4j.message.MessageFactory2`
- `org.apache.logging.log4j.message.MessageFactory`

## 使用

> 静态还是非静态

建议使用静态的 Logger，因为创建 Logger 很昂贵，而 Logger 被关联的 LoggerContext 关联，不会将其回收。
[Log4j2 中文文档 - Usage | Docs4dev](https://www.docs4dev.com/docs/zh/log4j2/2.x/all/manual-usage.html)


> 关于性能

![[log4j2打印消耗性能的操作.png]]



# Logstash

1. Exception, run, request, response log 输出的格式不同, 如何配置 logstash 来收集这个不同格式的日志。