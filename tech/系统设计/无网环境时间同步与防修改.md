
# 场景

我们售卖打包的软件，并授予一段时间的使用权。那么如何让软件到期失效，获得再次授权后方可使用。

# 系统设计

> 1. 确定授权的开始时间

手工维护一条记录，id + 创建时间 + hash (id + 创建时间)。该记录是管理员手动维护，如果记录不存在则软件授权失败。

管理员手动创建的记录，那么默认创建时间是准确的。Hash 的作用是建立 id 和时间的对应关系，防止时间被篡改。

> 2. 确定到期时间

每次软件登录/开启，计算当前时间与创建时间的差值，并与授权期限，如 365 天，进行对比。如果超过则软件授权过期。

# 确定当前时间

思考方向：2 B 用户和 2 C 用户。

## 有网

有网的情况下，当前时间可以通过访问授权服务器获取。获取方式有：

1. 获取 token，token 包含时间信息，防止中间人代理；
2. 输入登录令牌，该令牌包含时间信息，加密防篡改。

## 无网

无网的情况下，当前时间只能通过本机系统时间来获取。但是本机的系统时间是可以被修改的，那么我们授权也可以被破解。因此，如何在无网环境下获取到准确的当前时间是我们要思考的重点。


> TO B

TO B 用户更多是建立合作关系的用户，破解的意愿一般没那么强烈。

1. 永久买断授权，或者签订合同按每年收取（软件加密），免去复杂的系统设计；
2. 定时记录系统时间到本地数据库中，对比当前时间与上一次记录的时间对比，当前时间是否被篡改;（如果关机了，时间就记录不上了）
3. 绑定硬件，硬件外置独立记录时间；
4. 将时间糅合到正式业务中，修改时间影响到正式业务（合同声明）；


> TO C

1. 买断授权，无需依赖时间；
2. 强制联网设计；
3. 不赚软件费用，无需依赖本地时间。


需知道：攻与防，相生相成，没有一种方案是银弹。